
每日知识点记录

----------------------------------------------------------

开始时间
2020/01/10

有时候可能没时间，所以尽量一天记录一些吧

----------------------------------------------------------

2020/01/10 详细记录

----------------------------------------------------------

github 上传拉取 卡住不动
	https://www.ipaddress.com/
	查询 github.global.ssl.fastly.net 和 github.com 两个地址
	修改C:\Windows\System32\drivers\etc\hosts
	linux/mac执行sudo /etc/init.d/networking restart命令；
	windows在cmd中输入ipconfig /flushdns命令

上传图片
	https://www.cnblogs.com/fozero/p/8835628.html
        var formFile = new FormData();
        formFile.append("img", $('#upload').get(0).files[0]);

----------------------------------------------------------

2020/01/11 详细记录

----------------------------------------------------------

今天主要是做服务器的部署
使用之前的nginx和uwsgi配置
修改一些路径就可以配置好静态服务器和动态服务器了
主要的难点是守护进程 celery 
下面是一些参考资料
https://www.jianshu.com/p/9869cd1cbefe 配置
https://blog.csdn.net/qq_18863573/article/details/52437689
https://blog.csdn.net/sdafhkjas/article/details/102780983 解决错误

上线一些操作
设置路径
STATIC_ROOT = os.path.join(os.path.join(BASE_DIR, 'Jobs_web_django'), 'static')

收集静态文件
python manage.py collectstatic

收集依赖包
pip freeze > requirments.txt
安装依赖包
pip install -r requirments.txt

启动uWSGI
uwsgi --ini uwsgi.ini
ps -ef|grep uwsgi
关闭
uwsgi --stop uwsgi.pid
kill -9 n

开启nginx
nginx -c /var/www/Jobs_web_django/nginx.conf
关闭
nginx -s stop

上线服务器访问
http://49.234.125.109/

celery 配置
pip install supervisor
mkdir /etc/supervisor
echo_supervisord_conf > /etc/supervisor/supervisord.conf
mkdir supervisord.conf.d
cd supervisord.conf.d
touch celeryd_worker.conf

unlink /var/run/supervisor.sock
unlink /tmp/supervisor.sock

/root/.virtualenvs/jobenv/bin/supervisord -c supervisord.conf
supervisorctl status
supervisorctl update
supervisorctl reload
supervisorctl start all


----------------------------------------------------------

2020/01/13 详细记录

----------------------------------------------------------

修改charles的proxy配置，抓包手机访问
charles与爬虫的结合，APP爬取https需要ssl证书
需要手机root权限修改ssl证书，hash改名改目录为系统证书
参考资料
https://blog.csdn.net/ShadowySpirits/article/details/79756274

----------------------------------------------------------

2020/01/14 详细记录

----------------------------------------------------------

今天给博客增加了错误的工厂类，以及日志模块
以下是日志模块多线程解决的一些方案
https://www.jianshu.com/p/ab7fbe6f8f3c
https://www.jianshu.com/p/d615bf01e37b

下午增加了下猴子补丁的功能
通过增加models.Model的属性
再通过classmethod、装饰器等方法
在__init__上动态添加功能

linux上全局替换
grep -rl objects.get . --exclude-dir=lib | xargs sed 's/objects.get/get/g'

晚上学习了使用原始redis
修改原始redis，后台celery计算推荐的人存进redis
后面就从redis里面取值
rds.zrevrange('Hot-Rank', 0, config.TOP_N, withscores=True)
users = sorted(users, key=lambda user: uid_list.index(user.id))
rds.zincrby(config.HOT_RANK, config.LIKE_SCORE, keys.HOT_RANK_KEY % sid)

rds.sadd('%s' % user.id, *rcmd_user_id_list)
rds.srem('RCMD-%S' % request.user.id, sid)
rds.srandmember("", 10)

----------------------------------------------------------

2020/01/15 详细记录

----------------------------------------------------------

分布式数据库

范围拆分  //
 优点：扩容方便  缺点：分配不均衡
按余数拆分 %
 优点：分配均衡  缺点：扩容不方便

Mycat数据库分库分表中间件

主从、读写分离     写的命令发给主、读的命令发给从
master <- 写操作
 |
 V
slaver -> 读操作
slaver -> 读操作
slaver -> 读操作

程序实现或者第三方代理

服务高可用
 keepalived
 zookeeper
 服务器主挂，从接管
 1.备份
 2.故障转移
 3.交汇点，域名解析失败直接访问ip

ab 压力测试 服务器压力来自用户请求
 Ubuntu  
  apt-get install apache2-utils
  ab -n 1000 -c 3000 http://49.234.125.109/login/
  netstat -nat|grep 49.234.125.109
  ulimit -n
     多少次  并行
     -t 时间 -k keepalived

import socket
listen_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)  # 建立SOCK连接
listen_socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR)  # 设置参数
listen_socket.bind((HOST, POST))  # 绑定 IP:端口
listen_socket.listen(100)  # 开始监听

while True:
    client_socket, client_address = listen_socket.accept()  # 接收客户端发起的连接请求
    request = client_socket.recv(1024) 

    http_response = RESPONSE
    client_socket.sendall(http_response)
    client_socket.close()
pip install gunicorn
pip install gevent
gunicorn -c swiper/gunicorn-config.py swiper.wsgi
ps aux|grep gunicorn

kill `cat logs/gunicorn.pid`

gunicorn 
 master只管理子进程
 多个worker

echo测试  整个系统最大性能  8000 r/s
curl http://49.234.125.109/login/

带缓存测试  3000 r/s
带数据库测试 300 r/s

Nginx 6W r/s

redis测试  11W r/s
redis-benchmark

服务器不要安装来历不明的包
下载包 apt install

cd ~/download/nginx-1.14.1
make clean 清除makefile
./config  检查并产生makefile
make    执行编译
make install

服务器远程登录
ssh root@xxx.xxx.xxx.xxx
ssh-keygen 产生  -t ed25519 指定算法
~/.ss/id_rsa.pub 公钥
~/.ss/id_rsa 私钥

cat ~/.ssh/authorized_keys

删除
rm -rf 

上传服务器
rsync -crvP  --exclude={.venv,.git,__pycache__,logs} ./  root@xxx.xxx.xxx.xxx:/opt/swiper/

Nginx 负载均衡 
 轮询
 权重
 IP Hash
 最小连接数

upstream app_server{
	server 127.0.0.1:9000 weight=10;
	server 127.0.0.1:9000 weight=10;
}

location / {
	
}



----------------------------------------------------------

2020/01/14 详细记录

----------------------------------------------------------
----------------------------------------------------------

2020/01/14 详细记录

----------------------------------------------------------
----------------------------------------------------------

2020/01/14 详细记录

----------------------------------------------------------
----------------------------------------------------------

2020/01/14 详细记录

----------------------------------------------------------
----------------------------------------------------------
----------------------------------------------------------
----------------------------------------------------------
----------------------------------------------------------
----------------------------------------------------------
----------------------------------------------------------
----------------------------------------------------------
----------------------------------------------------------
----------------------------------------------------------
----------------------------------------------------------
----------------------------------------------------------
----------------------------------------------------------
----------------------------------------------------------
----------------------------------------------------------
----------------------------------------------------------
----------------------------------------------------------
----------------------------------------------------------